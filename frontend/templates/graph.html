<!DOCTYPE html>
<html>
  <head>
    <title>Graph Preview</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
      }
      #cy {
        width: 100%;
        height: calc(100vh - 180px);
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        max-height: 70vh;
        overflow-y: auto;
        border-radius: 4px;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover {
        color: black;
      }
      .property-list {
        list-style-type: none;
        padding: 0;
      }
      .property-item {
        margin: 10px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      .back-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #0074d9;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .back-button:hover {
        background-color: #0056a4;
      }
      .mode-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #2ecc40;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-right: 10px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.2s ease;
      }
      .mode-button.active {
        border-color: #fff;
        box-shadow: 0 0 0 3px #2ecc40;
      }
      .mode-button:hover {
        opacity: 0.9;
      }
      .delete-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #ff851b;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-right: 10px;
        cursor: not-allowed;
        border: 3px solid transparent;
        transition: all 0.2s ease;
        opacity: 0.5;
      }
      .delete-button.active {
        cursor: pointer;
        opacity: 1;
        border-color: #fff;
        box-shadow: 0 0 0 3px #ff851b;
      }
      .delete-button:hover.active {
        opacity: 0.9;
      }
      .controls {
        margin-bottom: 20px;
      }
      h2 {
        margin-top: 0;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <a href="{% url 'board_detail' board_id %}" class="back-button">
      ‚Üê Back to Board
    </a>
    <h2>Graph Preview</h2>

    <div class="controls">
      <div class="mode-button" id="viewMode">View Properties</div>
      <div class="mode-button" id="connectMode">Connect Nodes</div>
      <div class="delete-button" id="deleteEdge">Delete Connection</div>
    </div>

    <div id="cy"></div>

    <!-- Node Details Modal -->
    <div id="nodeModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="nodeName"></h2>
        <div id="nodeProperties" class="property-list"></div>
      </div>
    </div>

    <div id="edge-creation-dialog" class="modal" style="display: none;">
      <div class="modal-content">
        <h3>Create Edge</h3>
        <p>
          From:
          <span id="from-node-name"></span>
        </p>
        <p>
          To:
          <span id="to-node-name"></span>
        </p>
        <div class="form-group">
          <label for="edge-label">Edge Label:</label>
          <input
            type="text"
            id="edge-label"
            maxlength="50"
            placeholder="Enter edge label (optional)"
          />
        </div>
        <div class="button-group">
          <button onclick="confirmCreateEdge()" class="btn btn-primary">
            Create
          </button>
          <button onclick="cancelCreateEdge()" class="btn btn-secondary">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      const boardId = '{{ board_id }}'
      const csrfToken = '{{ csrf_token }}'
      let selectedNode = null
      let selectedEdge = null
      let isConnectMode = false
      const modal = document.getElementById('nodeModal')
      const closeBtn = document.getElementsByClassName('close')[0]
      const viewModeBtn = document.getElementById('viewMode')
      const connectModeBtn = document.getElementById('connectMode')
      const deleteEdgeBtn = document.getElementById('deleteEdge')
      let selectedFromNode = null
      let selectedToNode = null
      let edgeCreationMode = false
      let cy = null

      function clearSelectedEdge() {
        if (selectedEdge) {
          selectedEdge.removeClass('selected')
          selectedEdge = null
          deleteEdgeBtn.classList.remove('active')
        }
      }

      // Mode switching
      viewModeBtn.addEventListener('click', () => {
        isConnectMode = false
        viewModeBtn.classList.add('active')
        connectModeBtn.classList.remove('active')
        if (selectedNode) {
          selectedNode.removeClass('selected')
          selectedNode = null
        }
        clearSelectedEdge()
      })

      connectModeBtn.addEventListener('click', () => {
        isConnectMode = true
        connectModeBtn.classList.add('active')
        viewModeBtn.classList.remove('active')
        if (selectedNode) {
          selectedNode.removeClass('selected')
          selectedNode = null
        }
        clearSelectedEdge()
      })

      // Delete edge button click handler
      deleteEdgeBtn.addEventListener('click', () => {
        if (selectedEdge) {
          const sourceNode = cy.getElementById(selectedEdge.data('source'))
          const targetNode = cy.getElementById(selectedEdge.data('target'))

          if (confirm('Are you sure you want to delete this connection?')) {
            fetch('/api/edge/delete/', {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              credentials: 'include',
              body: `from=${sourceNode.id()}&to=${targetNode.id()}&board=${boardId}`,
            })
              .then((response) => {
                if (!response.ok) throw new Error('Network response was not ok')
                return response.json()
              })
              .then((data) => {
                if (data.status === 'deleted') {
                  cy.remove(selectedEdge)
                  clearSelectedEdge()
                } else {
                  throw new Error(data.message || 'Failed to delete connection')
                }
              })
              .catch((error) => {
                console.error('Error:', error)
                alert('Failed to delete connection: ' + error.message)
              })
          }
        }
      })

      // Close modal when clicking the X
      closeBtn.onclick = function () {
        modal.style.display = 'none'
      }

      // Close modal when clicking outside of it
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = 'none'
        }
      }

      // Initialize cytoscape and load data
      fetch(`/api/board/${boardId}/graph/`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
          return response.json()
        })
        .then((data) => {
          const elements = []

          // Add nodes
          data.nodes.forEach((node) => {
            elements.push({
              group: 'nodes',
              data: {
                id: node.id.toString(),
                label: node.name,
                properties: node.properties || {},
              },
            })
          })

          // Add edges
          data.edges.forEach((edge) => {
            elements.push({
              group: 'edges',
              data: {
                id: `edge-${edge.from}-${edge.to}`,
                source: edge.from.toString(),
                target: edge.to.toString(),
                label: edge.label || '',
              },
            })
          })

          // Initialize cytoscape
          cy = cytoscape({
            container: document.getElementById('cy'),
            elements: elements,
            style: [
              {
                selector: 'node',
                style: {
                  'background-color': '#2ecc40',
                  label: 'data(label)',
                  'text-valign': 'center',
                  'text-halign': 'center',
                  'font-size': '14px',
                  'text-wrap': 'wrap',
                  'text-max-width': '80px',
                  width: '80px',
                  height: '80px',
                  color: '#000000',
                  'text-outline-color': '#ffffff',
                  'text-outline-width': 2,
                },
              },
              {
                selector: 'node.selected',
                style: {
                  'background-color': '#FF4136',
                },
              },
              {
                selector: 'edge',
                style: {
                  'curve-style': 'bezier',
                  'target-arrow-shape': 'triangle',
                  'line-color': '#666',
                  width: 2,
                  label: 'data(label)',
                  'text-rotation': 'autorotate',
                  'text-margin-y': -10,
                  'font-size': '12px',
                  'text-outline-color': '#ffffff',
                  'text-outline-width': 2,
                  'text-background-color': '#ffffff',
                  'text-background-opacity': 0.8,
                  'text-background-padding': '2px',
                },
              },
              {
                selector: 'edge.selected',
                style: {
                  'line-color': '#ff851b',
                  width: 4,
                },
              },
            ],
            layout: {
              name: 'cose',
              idealEdgeLength: 100,
              nodeOverlap: 20,
              refresh: 20,
              fit: true,
              padding: 30,
              randomize: false,
              componentSpacing: 100,
              nodeRepulsion: 400000,
              edgeElasticity: 100,
              nestingFactor: 5,
              gravity: 80,
              numIter: 1000,
              initialTemp: 200,
              coolingFactor: 0.95,
              minTemp: 1.0,
            },
          })

          // Node click handler
          cy.on('tap', 'node', function (evt) {
            const node = evt.target
            const nodeData = node.data()

            if (isConnectMode) {
              if (!selectedNode) {
                selectedNode = node
                node.addClass('selected')
              } else {
                if (selectedNode.id() !== node.id()) {
                  const fromId = selectedNode.id()
                  const toId = node.id()

                  // Check if edge already exists
                  const existingEdge = cy.edges(
                    `[source = "${fromId}"][target = "${toId}"]`,
                  )
                  if (existingEdge.length > 0) {
                    alert('Connection already exists!')
                    selectedNode.removeClass('selected')
                    selectedNode = null
                    return
                  }

                  // Prompt for edge label
                  const label = prompt(
                    'Enter a label for this connection (max 50 characters):',
                    '',
                  )
                  if (label === null) {
                    // User clicked Cancel
                    selectedNode.removeClass('selected')
                    selectedNode = null
                    return
                  }

                  if (!label.trim()) {
                    alert('Please enter a label for the connection.')
                    selectedNode.removeClass('selected')
                    selectedNode = null
                    return
                  }

                  if (label.length > 50) {
                    alert('Label is too long. Maximum 50 characters allowed.')
                    selectedNode.removeClass('selected')
                    selectedNode = null
                    return
                  }

                  fetch('/api/edge/add/', {
                    method: 'POST',
                    headers: {
                      'X-CSRFToken': csrfToken,
                      'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    credentials: 'include',
                    body: `from=${fromId}&to=${toId}&board=${boardId}&label=${encodeURIComponent(
                      label,
                    )}`,
                  })
                    .then((response) => {
                      if (!response.ok)
                        throw new Error('Network response was not ok')
                      return response.json()
                    })
                    .then((data) => {
                      if (data.status === 'ok') {
                        cy.add({
                          group: 'edges',
                          data: {
                            id: `edge-${fromId}-${toId}`,
                            source: fromId,
                            target: toId,
                            label: label,
                          },
                        })
                      } else {
                        throw new Error('Failed to create connection')
                      }
                    })
                    .catch((error) => {
                      console.error('Error:', error)
                      alert('Failed to create connection')
                    })
                    .finally(() => {
                      selectedNode.removeClass('selected')
                      selectedNode = null
                    })
                }
              }
            } else {
              // Show node details in modal
              document.getElementById('nodeName').textContent = nodeData.label
              const propertiesDiv = document.getElementById('nodeProperties')
              propertiesDiv.innerHTML = ''

              if (
                nodeData.properties &&
                Object.keys(nodeData.properties).length > 0
              ) {
                for (const [key, value] of Object.entries(
                  nodeData.properties,
                )) {
                  const propertyItem = document.createElement('div')
                  propertyItem.className = 'property-item'
                  propertyItem.innerHTML = `<strong>${key}:</strong> ${value}`
                  propertiesDiv.appendChild(propertyItem)
                }
              } else {
                propertiesDiv.innerHTML = '<p>No properties available.</p>'
              }

              modal.style.display = 'block'
            }
          })

          // Edge click handler
          cy.on('tap', 'edge', function (evt) {
            evt.preventDefault() // Prevent any default handling
            const edge = evt.target

            // Clear any previously selected edge
            cy.edges().removeClass('selected')
            clearSelectedEdge()

            // Select the new edge
            selectedEdge = edge
            edge.addClass('selected')
            deleteEdgeBtn.classList.add('active')

            console.log('Edge selected:', edge.id())
          })

          // Background click handler
          cy.on('tap', function (event) {
            if (event.target === cy) {
              if (selectedNode) {
                selectedNode.removeClass('selected')
                selectedNode = null
              }
              cy.edges().removeClass('selected')
              clearSelectedEdge()
            }
          })

          // Start in view mode by default
          viewModeBtn.click()
        })
        .catch((error) => {
          console.error('Error loading graph data:', error)
          alert('Failed to load graph data: ' + error.message)
        })

      function startEdgeCreation(nodeId, nodeName) {
        if (!edgeCreationMode) {
          selectedFromNode = nodeId
          document.getElementById('from-node-name').textContent = nodeName
          edgeCreationMode = true
          document.getElementById('edge-creation-dialog').style.display =
            'block'
        } else if (nodeId !== selectedFromNode) {
          selectedToNode = nodeId
          document.getElementById('to-node-name').textContent = nodeName
          // Don't create the edge immediately, let user add label first
        }
      }

      function confirmCreateEdge() {
        if (selectedFromNode && selectedToNode) {
          const label = document.getElementById('edge-label').value.trim()
          createEdge(selectedFromNode, selectedToNode, label)
        }
      }

      function cancelCreateEdge() {
        resetEdgeCreation()
      }

      function resetEdgeCreation() {
        selectedFromNode = null
        selectedToNode = null
        edgeCreationMode = false
        document.getElementById('edge-creation-dialog').style.display = 'none'
        document.getElementById('edge-label').value = ''
        document.getElementById('from-node-name').textContent = ''
        document.getElementById('to-node-name').textContent = ''
      }

      function createEdge(fromNodeId, toNodeId, label) {
        const boardId = document.getElementById('board-id').value
        fetch('/api/create-edge/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({
            from_node_id: fromNodeId,
            to_node_id: toNodeId,
            board_id: boardId,
            label: label || '',
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'success') {
              // Add the edge to the network using vis.js format
              const edges = network.body.data.edges
              edges.add([
                {
                  from: fromNodeId,
                  to: toNodeId,
                  label: label || '',
                },
              ])
              showMessage('Edge created successfully', 'success')
            } else {
              showMessage(data.message || 'Failed to create edge', 'error')
            }
          })
          .catch((error) => {
            console.error('Error:', error)
            showMessage('Failed to create edge', 'error')
          })
          .finally(() => {
            resetEdgeCreation()
          })
      }
    </script>
  </body>
</html>
