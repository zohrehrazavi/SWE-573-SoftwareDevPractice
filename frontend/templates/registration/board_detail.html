<!DOCTYPE html>
<html>
  <head>
    <title>{{ board.name }}</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
      }
      #cy {
        width: 100%;
        height: 500px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin: 20px 0;
        background-color: #f8f9fa;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        max-height: 70vh;
        overflow-y: auto;
        border-radius: 4px;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover {
        color: black;
      }
      .property-list {
        list-style-type: none;
        padding: 0;
      }
      .property-item {
        margin: 10px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      .controls {
        margin: 20px 0;
      }
      .mode-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-right: 10px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.2s ease;
      }
      .mode-button.active {
        border-color: #fff;
        box-shadow: 0 0 0 3px #4caf50;
      }
      .delete-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #f44336;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-right: 10px;
        cursor: not-allowed;
        opacity: 0.5;
      }
      .delete-button.active {
        cursor: pointer;
        opacity: 1;
        border-color: #fff;
        box-shadow: 0 0 0 3px #f44336;
      }
      .board-tags {
        margin: 8px 0 12px 0;
      }
      .tag-pill {
        display: inline-block;
        background: #e0e7ef;
        color: #333;
        border-radius: 12px;
        padding: 2px 10px;
        font-size: 0.9em;
        margin-right: 4px;
        margin-bottom: 2px;
      }
      .edit-board-btn {
        background: #f0f0f0;
        color: #333;
        border-radius: 6px;
        padding: 6px 16px;
        text-decoration: none;
        border: 1px solid #d1d5db;
        font-size: 1em;
        transition: background 0.2s;
      }
      .edit-board-btn:hover {
        background: #e0e7ef;
      }
    </style>
  </head>
  <body>
    <h2>Board: {{ board.name }}</h2>
    <p>Created at: {{ board.created_at }}</p>
    {% if board.board_tags %}
    <div class="board-tags">
      {% for tag in board.board_tags %}
      <span class="tag-pill">{{ tag }}</span>
      {% endfor %}
    </div>
    {% endif %}
    <a
      href="{% url 'edit_board' board.id %}"
      class="edit-board-btn"
      style="margin-bottom: 10px; display: inline-block;"
    >
      Edit Board
    </a>

    <h3>Nodes on this board:</h3>
    {% if nodes %}
    <ul>
      {% for node in nodes %}
      <li>
        <a href="{% url 'node_detail' node.id %}">{{ node.name }}</a>
        {% if node.properties %}(Enriched){% endif %}
        <br />
        <a href="{% url 'fetch_node_properties' node.id %}">
          ➕ Fetch Wikidata Properties
        </a>
        |
        <a
          href="{% url 'delete_node' node.id %}"
          onclick="return confirm('Are you sure you want to delete this node?');"
        >
          ❌ Delete
        </a>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p>No nodes yet.</p>
    {% endif %}

    <a href="{% url 'create_node' board.id %}">+ Add New Node</a>
    <br />
    <a href="{% url 'home' %}">← Back to Home</a>

    <div class="controls">
      <div class="mode-button" id="viewMode">View Properties</div>
      <div class="mode-button" id="connectMode">Connect Nodes</div>
      <div class="delete-button" id="deleteEdge">Delete Connection</div>
    </div>

    <div id="cy"></div>

    <!-- Node Details Modal -->
    <div id="nodeModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="nodeName"></h2>
        <div id="nodeProperties" class="property-list"></div>
      </div>
    </div>

    <script>
      const boardId = '{{ board.id }}'
      const csrfToken = '{{ csrf_token }}'
      let selectedNode = null
      let selectedEdge = null
      let isConnectMode = false
      const modal = document.getElementById('nodeModal')
      const closeBtn = document.getElementsByClassName('close')[0]
      const viewModeBtn = document.getElementById('viewMode')
      const connectModeBtn = document.getElementById('connectMode')
      const deleteEdgeBtn = document.getElementById('deleteEdge')
      let cy = null

      function clearSelectedEdge() {
        if (selectedEdge) {
          selectedEdge.removeClass('selected')
          selectedEdge = null
          deleteEdgeBtn.classList.remove('active')
        }
      }

      // Mode switching
      viewModeBtn.addEventListener('click', () => {
        isConnectMode = false
        viewModeBtn.classList.add('active')
        connectModeBtn.classList.remove('active')
        if (selectedNode) {
          selectedNode.removeClass('selected')
          selectedNode = null
        }
        clearSelectedEdge()
      })

      connectModeBtn.addEventListener('click', () => {
        isConnectMode = true
        connectModeBtn.classList.add('active')
        viewModeBtn.classList.remove('active')
        if (selectedNode) {
          selectedNode.removeClass('selected')
          selectedNode = null
        }
        clearSelectedEdge()
      })

      // Delete edge button click handler
      deleteEdgeBtn.addEventListener('click', () => {
        if (selectedEdge) {
          const sourceNode = cy.getElementById(selectedEdge.data('source'))
          const targetNode = cy.getElementById(selectedEdge.data('target'))

          if (confirm('Are you sure you want to delete this connection?')) {
            fetch('/api/edge/delete/', {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              credentials: 'include',
              body: `from=${sourceNode.id()}&to=${targetNode.id()}&board=${boardId}`,
            })
              .then((response) => {
                if (!response.ok) throw new Error('Network response was not ok')
                return response.json()
              })
              .then((data) => {
                if (data.status === 'deleted') {
                  cy.remove(selectedEdge)
                  clearSelectedEdge()
                } else {
                  throw new Error(data.message || 'Failed to delete connection')
                }
              })
              .catch((error) => {
                console.error('Error:', error)
                alert('Failed to delete connection: ' + error.message)
              })
          }
        }
      })

      // Close modal when clicking the X
      closeBtn.onclick = function () {
        modal.style.display = 'none'
      }

      // Close modal when clicking outside of it
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = 'none'
        }
      }

      function loadGraph() {
        fetch(`/api/board/${boardId}/graph/`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`)
            }
            return response.json()
          })
          .then((data) => {
            const elements = []

            // Add nodes
            data.nodes.forEach((node) => {
              elements.push({
                group: 'nodes',
                data: {
                  id: node.id.toString(),
                  label: node.name,
                  properties: node.properties || {},
                },
              })
            })

            // Add edges
            data.edges.forEach((edge) => {
              elements.push({
                group: 'edges',
                data: {
                  id: `edge-${edge.from}-${edge.to}`,
                  source: edge.from.toString(),
                  target: edge.to.toString(),
                  label: edge.label || '',
                },
              })
            })

            // Initialize or update cytoscape
            if (cy) {
              cy.destroy()
            }

            cy = cytoscape({
              container: document.getElementById('cy'),
              elements: elements,
              style: [
                {
                  selector: 'node',
                  style: {
                    'background-color': '#3498db',
                    'border-color': '#2980b9',
                    'border-width': '2px',
                    label: 'data(label)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '10px',
                    color: '#fff',
                    'text-outline-color': '#3498db',
                    'text-outline-width': '2px',
                    width: 'label',
                    height: 'label',
                    padding: '15px',
                    shape: 'ellipse',
                    'text-max-width': '100px',
                  },
                },
                {
                  selector: 'edge',
                  style: {
                    width: 1.5,
                    'line-color': '#95a5a6',
                    'target-arrow-color': '#95a5a6',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    label: 'data(label)',
                    'font-size': '8px',
                    'text-rotation': 'autorotate',
                    'text-margin-y': '-10px',
                    'text-background-color': '#fff',
                    'text-background-opacity': 0.8,
                    'text-background-padding': '2px',
                  },
                },
                {
                  selector: '.selected',
                  style: {
                    'background-color': '#2ecc71',
                    'border-color': '#27ae60',
                    'line-color': '#2ecc71',
                    'target-arrow-color': '#2ecc71',
                    'text-outline-color': '#2ecc71',
                  },
                },
                {
                  selector: 'node:selected',
                  style: {
                    'border-width': '4px',
                    'border-color': '#f1c40f',
                    'border-opacity': 0.8,
                  },
                },
                {
                  selector: 'edge:selected',
                  style: {
                    width: 3,
                    'line-color': '#e74c3c',
                    'target-arrow-color': '#e74c3c',
                  },
                },
              ],
              layout: {
                name: 'cose',
                idealEdgeLength: 150,
                nodeOverlap: 20,
                refresh: 20,
                fit: true,
                padding: 30,
                randomize: false,
                componentSpacing: 100,
                nodeRepulsion: 500000,
                edgeElasticity: 100,
                nestingFactor: 5,
                gravity: 80,
                numIter: 1000,
                initialTemp: 200,
                coolingFactor: 0.95,
                minTemp: 1.0,
              },
            })

            // Node click handler
            cy.on('tap', 'node', function (evt) {
              const node = evt.target
              const nodeData = node.data()

              if (isConnectMode) {
                if (!selectedNode) {
                  selectedNode = node
                  node.addClass('selected')
                } else {
                  const fromId = selectedNode.id()
                  const toId = node.id()

                  // Prevent self-connections
                  if (fromId === toId) {
                    alert('Cannot connect a node to itself!')
                    selectedNode.removeClass('selected')
                    selectedNode = null
                    return
                  }

                  const label = prompt(
                    'Enter a label for this connection (optional):',
                  )

                  fetch('/api/edge/add/', {
                    method: 'POST',
                    headers: {
                      'X-CSRFToken': csrfToken,
                      'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    credentials: 'include',
                    body: `from=${fromId}&to=${toId}&board=${boardId}&label=${encodeURIComponent(
                      label || '',
                    )}`,
                  })
                    .then((response) => {
                      if (!response.ok)
                        throw new Error('Network response was not ok')
                      return response.json()
                    })
                    .then((data) => {
                      if (data.status === 'ok') {
                        cy.add({
                          group: 'edges',
                          data: {
                            id: `edge-${fromId}-${toId}`,
                            source: fromId,
                            target: toId,
                            label: label || '',
                          },
                        })
                      } else {
                        throw new Error('Failed to create connection')
                      }
                    })
                    .catch((error) => {
                      console.error('Error:', error)
                      alert('Failed to create connection')
                    })
                    .finally(() => {
                      selectedNode.removeClass('selected')
                      selectedNode = null
                    })
                }
              } else {
                // Show node details in modal
                document.getElementById('nodeName').textContent = nodeData.label
                const propertiesDiv = document.getElementById('nodeProperties')
                propertiesDiv.innerHTML = ''

                if (
                  nodeData.properties &&
                  Object.keys(nodeData.properties).length > 0
                ) {
                  for (const [key, value] of Object.entries(
                    nodeData.properties,
                  )) {
                    const propertyItem = document.createElement('div')
                    propertyItem.className = 'property-item'
                    propertyItem.innerHTML = `<strong>${key}:</strong> ${value}`
                    propertiesDiv.appendChild(propertyItem)
                  }
                } else {
                  propertiesDiv.innerHTML = '<p>No properties available.</p>'
                }

                modal.style.display = 'block'
              }
            })

            // Edge click handler
            cy.on('tap', 'edge', function (evt) {
              evt.preventDefault()
              const edge = evt.target

              // Clear any previously selected edge
              cy.edges().removeClass('selected')
              clearSelectedEdge()

              // Select the new edge
              selectedEdge = edge
              edge.addClass('selected')
              deleteEdgeBtn.classList.add('active')
            })

            // Background click handler
            cy.on('tap', function (event) {
              if (event.target === cy) {
                if (selectedNode) {
                  selectedNode.removeClass('selected')
                  selectedNode = null
                }
                clearSelectedEdge()
              }
            })
          })
          .catch((error) => {
            console.error('Error loading graph data:', error)
            alert('Failed to load graph data: ' + error.message)
          })
      }

      // Start in view mode and load the graph
      viewModeBtn.click()
      loadGraph()

      // Reload graph when nodes are added or deleted
      document.addEventListener('DOMContentLoaded', function () {
        const createNodeLink = document.querySelector('a[href*="create_node"]')
        const deleteNodeLinks = document.querySelectorAll(
          'a[href*="delete_node"]',
        )

        if (createNodeLink) {
          createNodeLink.addEventListener('click', function () {
            setTimeout(loadGraph, 1000) // Reload after node creation
          })
        }

        deleteNodeLinks.forEach((link) => {
          link.addEventListener('click', function () {
            setTimeout(loadGraph, 1000) // Reload after node deletion
          })
        })
      })
    </script>
  </body>
</html>
